$(function() {

  if (room) {

    var messages = new Chamber.Collections.MessagesCollection
    messages.url = '/rooms/' + room.id + '/messages'

    var participants = new Chamber.Collections.ParticipantsCollection
    participants.url = '/rooms/' + room.id + '/participants'

    var room_show_view = new Chamber.Views.Rooms.ShowView(
      {
        messages: messages,
        participants: participants,
        model: room,
        el: $("#room")
      }
    )

    var juggernaut = new Juggernaut({
      secure: false,
      host: "<%= Chamber::Application.config.juggernaut_host %>",
      port: <%= Chamber::Application.config.juggernaut_port %>,
      transports: ['xhr-polling', 'jsonp-polling']
    })

    // Subscribe to messages in this room.
    juggernaut.subscribe("rooms:" + room.id + ":messages", function(data) {
      if(data.action == "create") {
        var message = new Chamber.Models.Message(data.message);
        messages.add(message)
      }
    });

    // Subscribe to participants in this room.
    juggernaut.subscribe("rooms:" + room.id + ":participants", function(data) {
      if(data.action == "create") {
        var participant = new Chamber.Models.Participant(data.participant);
        participants.add(participant)
      }
    });

  }
})
